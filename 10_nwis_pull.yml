target_default: 10_nwis_pull

packages:
  - dataRetrieval
  - yaml
  - maps
  - scipiper
  - dplyr
  
sources:
  - 10_nwis_pull/src/inventory_nwis.R
  - 10_nwis_pull/src/nwis_pull.R
  - 10_nwis_pull/src/compare_nwis_services.R
  - 10_nwis_pull/src/nwis_partition.R

targets:
  10_nwis_pull:
    depends:
      - 10_nwis_pull/out/nwis_dv_data.rds.ind
      - 10_nwis_pull/out/nwis_uv_data.rds.ind
      
# -- get a CONUS inventory of available data for download -- #

  nwis_pull_parameters:
    command: yaml.load_file('10_nwis_pull/cfg/nwis_pull_params.yml')
    
  nwis_pull_size: 
    command: I(250000)
    
  # -- get inventory of observations available to download -- #

  # dv data
  # force rebuild of the inventories if you want to start over
  10_nwis_pull/inout/nwis_dv_inventory.rds:
    command: inventory_nwis(inv_file = target_name,
      nwis_pull_params = nwis_pull_parameters, 
      service = I('dv'))
  
  # uv data 
  10_nwis_pull/inout/nwis_uv_inventory.rds:
    command: inventory_nwis(inv_file = target_name,
      nwis_pull_params = nwis_pull_parameters, 
      service = I('uv'))
    
  # create a table that compares services
  nwis_compare_services:
    command: compare_services(
      dv = '10_nwis_pull/inout/nwis_dv_inventory.rds', 
      uv = '10_nwis_pull/inout/nwis_uv_inventory.rds')
    
  # filter the UV inventory to only those sites that are not in DV
  # this isn't perfect - as some sites overlap but don't have the same data.
  
  nwis_uv_inventory_reduced:
    command: reduce_redundancy(compare = nwis_compare_services)

  # -- partition data -- #
  # dv
  nwis_dv_partition:
    command: partition_inventory(inventory = '10_nwis_pull/inout/nwis_dv_inventory.rds', nwis_pull_size) 
    
  #uv
  nwis_uv_partition:
    command: partition_inventory(inventory = nwis_uv_inventory_reduced, nwis_pull_size) 
    
  # -- create and execute tasks from pull table -- #

  # prepare a remake-style plan for running each partition as a separate
  # remake target in a separate remake file
  
  #dv
  nwis_dv_pull_plan:
    command: plan_nwis_pull(partitions = nwis_dv_partition, service = I('dv'))

  10_nwis_dv_pull_tasks.yml:
    command: create_nwis_pull_makefile(makefile=target_name, task_plan=nwis_dv_pull_plan,
      final_targets = I('10_nwis_pull/out/nwis_dv_data.rds.ind'))

  10_nwis_pull/out/nwis_dv_data.rds.ind:
    command: loop_tasks(task_plan=nwis_dv_pull_plan, task_makefile='10_nwis_dv_pull_tasks.yml',
      num_tries=I(30), sleep_on_error=I(20))
    depends:
      - 10_nwis_pull/src/nwis_pull.R
      
  10_nwis_pull/out/nwis_dv_data.rds:
    command: gd_get('10_nwis_pull/out/nwis_dv_data.rds.ind')
      
  #uv
  nwis_uv_pull_plan:
    command: plan_nwis_pull(partitions = nwis_uv_partition, service = I('uv'))

  10_nwis_uv_pull_tasks.yml:
    command: create_nwis_pull_makefile(makefile=target_name, task_plan=nwis_uv_pull_plan,
      final_targets = I('10_nwis_pull/out/nwis_uv_data.rds.ind'))

  10_nwis_pull/out/nwis_uv_data.rds.ind:
    command: loop_tasks(task_plan=nwis_uv_pull_plan, task_makefile='10_nwis_uv_pull_tasks.yml',
      num_tries=I(30), sleep_on_error=I(20))
    depends:
      - 10_nwis_pull/src/nwis_pull.R
      
  10_nwis_pull/out/nwis_uv_data.rds:
    command: gd_get('10_nwis_pull/out/nwis_uv_data.rds.ind')
